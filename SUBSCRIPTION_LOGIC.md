# Логика рекуррентных платежей с тремя попытками

## Обзор

Система реализует логику рекуррентных платежей с тремя попытками списания, как в примере:
- 10 августа - списание не получилось
- 11 августа - не получилось списать, отправляем напоминание об оплате
- 12 августа - не получилось списать, убираем из канала

## Структура базы данных

### Новые поля в таблице `subscriptions`:

- `charge_attempts` (INTEGER) - количество попыток списания (по умолчанию 0)
- `last_charge_attempt` (TIMESTAMPTZ) - дата последней попытки списания

## Логика работы

### 1. Первая попытка списания
- Происходит в день следующего платежа (например, 10 августа)
- Если списание успешно: подписка продлевается, счетчик попыток сбрасывается
- Если списание неуспешно: счетчик попыток увеличивается до 1

### 2. Вторая попытка списания
- Происходит через день после первой попытки (например, 11 августа)
- Если списание успешно: подписка продлевается, счетчик попыток сбрасывается
- Если списание неуспешно: счетчик попыток увеличивается до 2, отправляется уведомление пользователю

### 3. Третья попытка списания
- Происходит через день после второй попытки (например, 12 августа)
- Если списание успешно: подписка продлевается, счетчик попыток сбрасывается
- Если списание неуспешно: пользователь удаляется из канала, подписка приостанавливается

## Новые методы в Database

### `increment_charge_attempts(subscription_id)`
Увеличивает счетчик попыток списания и обновляет дату последней попытки.

### `reset_charge_attempts(subscription_id)`
Сбрасывает счетчик попыток списания в 0.

### `get_charge_attempts(subscription_id)`
Возвращает текущее количество попыток списания.

### `remove_user_from_channel(user_id)`
Удаляет пользователя из канала (устанавливает статус подписки как 'expired').

### `get_first_payment_for_subscription(subscription_id)`
Получает order_code первого платежа подписки для использования в качестве `previous_inv_id` в рекуррентных списаниях.

## Модифицированные функции

### `charge_subscription_job()`
- Проверяет количество попыток перед списанием
- Увеличивает счетчик при каждой попытке
- Сбрасывает счетчик при успешном списании
- Планирует следующую попытку через день при неудаче
- Удаляет пользователя из канала после 3 неудачных попыток
- **Использует первый платеж подписки для `previous_inv_id`**

### `kick_subscription_job()`
- Проверяет количество попыток при исключении из канала
- Удаляет пользователя сразу, если превышено количество попыток

### `schedule_subscription_jobs()`
- Сбрасывает счетчик попыток при создании новой подписки

### `extend_subscription()`
- Сбрасывает счетчик попыток при успешном продлении подписки

## Важное изменение: Правильное получение previous_inv_id

Для рекуррентных платежей критически важно использовать `previous_inv_id` из самого первого успешного платежа, который активировал подписку, а не из последнего заказа.

### Логика получения первого платежа:
1. Получаем `order_id` из подписки
2. Получаем `order_code` из заказа
3. Используем этот `order_code` как `previous_inv_id` для всех рекуррентных списаний

Это обеспечивает, что все рекуррентные платежи ссылаются на один и тот же первоначальный платеж.

## Уведомления пользователям

### При неудачном списании (попытки 1-2):
```
⚠️ Не удалось списать оплату за подписку. Это последняя попытка. 
Пожалуйста, проверьте данные карты или обратитесь в поддержку.
```

### При превышении попыток (попытка 3):
```
❌ Ваша подписка была приостановлена из-за неудачных попыток списания. 
Для восстановления доступа обратитесь в поддержку.
```

### При успешном списании:
```
✅ Ваша подписка успешно продлена!
```

## Применение изменений

Для применения изменений выполните SQL-скрипт `fix_tables.sql`:

```sql
-- Добавление новых полей
ALTER TABLE subscriptions ADD COLUMN IF NOT EXISTS charge_attempts INTEGER DEFAULT 0;
ALTER TABLE subscriptions ADD COLUMN IF NOT EXISTS last_charge_attempt TIMESTAMPTZ;

-- Обновление существующих записей
UPDATE subscriptions SET charge_attempts = 0 WHERE charge_attempts IS NULL;
```

## Мониторинг

Логи системы будут содержать информацию о попытках списания:
- `✅ Рекуррентное списание отправлено для пользователя {user_id} (попытка {attempt})`
- `⚠️ Превышено количество попыток списания для подписки {subscription_id}`
- `✅ Пользователь {user_id} удален из канала из-за превышения попыток списания`
- `❌ Не удалось получить первый платеж для подписки {subscription_id}` 