# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏–∫–∏ —Ä–µ–∫—É—Ä—Ä–µ–Ω—Ç–Ω—ã—Ö –ø–ª–∞—Ç–µ–∂–µ–π —Å —Ç—Ä–µ–º—è –ø–æ–ø—ã—Ç–∫–∞–º–∏

## –ß—Ç–æ –±—ã–ª–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ

–°–∏—Å—Ç–µ–º–∞ —Ç–µ–ø–µ—Ä—å –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –ª–æ–≥–∏–∫—É —Ä–µ–∫—É—Ä—Ä–µ–Ω—Ç–Ω—ã—Ö –ø–ª–∞—Ç–µ–∂–µ–π —Å —Ç—Ä–µ–º—è –ø–æ–ø—ã—Ç–∫–∞–º–∏ —Å–ø–∏—Å–∞–Ω–∏—è:

1. **–ü–µ—Ä–≤–∞—è –ø–æ–ø—ã—Ç–∫–∞** (–Ω–∞–ø—Ä–∏–º–µ—Ä, 10 –∞–≤–≥—É—Å—Ç–∞) - –æ–±—ã—á–Ω–æ–µ —Å–ø–∏—Å–∞–Ω–∏–µ
2. **–í—Ç–æ—Ä–∞—è –ø–æ–ø—ã—Ç–∫–∞** (–Ω–∞–ø—Ä–∏–º–µ—Ä, 11 –∞–≤–≥—É—Å—Ç–∞) - –ø–æ–≤—Ç–æ—Ä–Ω–æ–µ —Å–ø–∏—Å–∞–Ω–∏–µ + —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
3. **–¢—Ä–µ—Ç—å—è –ø–æ–ø—ã—Ç–∫–∞** (–Ω–∞–ø—Ä–∏–º–µ—Ä, 12 –∞–≤–≥—É—Å—Ç–∞) - –ø–æ—Å–ª–µ–¥–Ω–µ–µ —Å–ø–∏—Å–∞–Ω–∏–µ + —É–¥–∞–ª–µ–Ω–∏–µ –∏–∑ –∫–∞–Ω–∞–ª–∞

### üî• –í–∞–∂–Ω–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: –ü—Ä–∞–≤–∏–ª—å–Ω–æ–µ –ø–æ–ª—É—á–µ–Ω–∏–µ previous_inv_id

**–ü—Ä–æ–±–ª–µ–º–∞:** –†–∞–Ω—å—à–µ –¥–ª—è —Ä–µ–∫—É—Ä—Ä–µ–Ω—Ç–Ω—ã—Ö –ø–ª–∞—Ç–µ–∂–µ–π –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª—Å—è `previous_inv_id` –∏–∑ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –∑–∞–∫–∞–∑–∞.

**–†–µ—à–µ–Ω–∏–µ:** –¢–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `previous_inv_id` –∏–∑ —Å–∞–º–æ–≥–æ –ø–µ—Ä–≤–æ–≥–æ –ø–ª–∞—Ç–µ–∂–∞, –∫–æ—Ç–æ—Ä—ã–π –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–ª –ø–æ–¥–ø–∏—Å–∫—É.

–≠—Ç–æ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω–æ –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —Ä–∞–±–æ—Ç—ã —Ä–µ–∫—É—Ä—Ä–µ–Ω—Ç–Ω—ã—Ö –ø–ª–∞—Ç–µ–∂–µ–π –≤ Robokassa.

## –®–∞–≥–∏ –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π

### 1. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

–í—ã–ø–æ–ª–Ω–∏—Ç–µ SQL-—Å–∫—Ä–∏–ø—Ç –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–≤—ã—Ö –ø–æ–ª–µ–π:

```bash
psql -h your_host -U your_user -d your_database -f fix_tables.sql
```

–ò–ª–∏ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ –∫–æ–º–∞–Ω–¥—ã –≤—Ä—É—á–Ω—É—é:

```sql
-- –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª–µ–π –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –ø–æ–ø—ã—Ç–æ–∫ —Å–ø–∏—Å–∞–Ω–∏—è
ALTER TABLE subscriptions ADD COLUMN IF NOT EXISTS charge_attempts INTEGER DEFAULT 0;
ALTER TABLE subscriptions ADD COLUMN IF NOT EXISTS last_charge_attempt TIMESTAMPTZ;

-- –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –∑–∞–ø–∏—Å–µ–π
UPDATE subscriptions SET charge_attempts = 0 WHERE charge_attempts IS NULL;
```

### 2. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–¥–∞

–í—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è —É–∂–µ –≤–Ω–µ—Å–µ–Ω—ã –≤ —Ñ–∞–π–ª—ã:

- ‚úÖ `src/postgresdb.py` - –¥–æ–±–∞–≤–ª–µ–Ω—ã –Ω–æ–≤—ã–µ –º–µ—Ç–æ–¥—ã, –≤–∫–ª—é—á–∞—è `get_first_payment_for_subscription()`
- ‚úÖ `src/subscription_jobs.py` - –º–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–∞ –ª–æ–≥–∏–∫–∞ —Å–ø–∏—Å–∞–Ω–∏—è —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º –ø–æ–ª—É—á–µ–Ω–∏–µ–º `previous_inv_id`
- ‚úÖ `fix_tables.sql` - SQL-—Å–∫—Ä–∏–ø—Ç –¥–ª—è –ë–î

### 3. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

–ó–∞–ø—É—Å—Ç–∏—Ç–µ —Ç–µ—Å—Ç–æ–≤—ã–π —Å–∫—Ä–∏–ø—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏:

```bash
cd src
python test_subscription_logic.py
```

### 4. –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –±–æ—Ç–∞

–ü–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ –±–æ—Ç–∞:

```bash
# –ï—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ Docker
docker-compose restart

# –ò–ª–∏ –µ—Å–ª–∏ –∑–∞–ø—É—Å–∫–∞–µ—Ç–µ –Ω–∞–ø—Ä—è–º—É—é
python src/__main__.py
```

## –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã

### –õ–æ–≥–∏ –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞

–°–∏—Å—Ç–µ–º–∞ –±—É–¥–µ—Ç –ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å —Å–ª–µ–¥—É—é—â–∏–µ —Å–æ–±—ã—Ç–∏—è:

```
‚úÖ –†–µ–∫—É—Ä—Ä–µ–Ω—Ç–Ω–æ–µ —Å–ø–∏—Å–∞–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è 123456 (–ø–æ–ø—ã—Ç–∫–∞ 1)
‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å —Å–ø–∏—Å–∞—Ç—å –æ–ø–ª–∞—Ç—É –∑–∞ –ø–æ–¥–ø–∏—Å–∫—É. –≠—Ç–æ –ø–æ—Å–ª–µ–¥–Ω—è—è –ø–æ–ø—ã—Ç–∫–∞.
‚ö†Ô∏è –ü—Ä–µ–≤—ã—à–µ–Ω–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø—ã—Ç–æ–∫ —Å–ø–∏—Å–∞–Ω–∏—è –¥–ª—è –ø–æ–¥–ø–∏—Å–∫–∏ 1
‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å 123456 —É–¥–∞–ª–µ–Ω –∏–∑ –∫–∞–Ω–∞–ª–∞ –∏–∑-–∑–∞ –ø—Ä–µ–≤—ã—à–µ–Ω–∏—è –ø–æ–ø—ã—Ç–æ–∫ —Å–ø–∏—Å–∞–Ω–∏—è
‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –ø–µ—Ä–≤—ã–π –ø–ª–∞—Ç–µ–∂ –¥–ª—è –ø–æ–¥–ø–∏—Å–∫–∏ 1
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö

```sql
-- –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–ø—ã—Ç–æ–∫ —Å–ø–∏—Å–∞–Ω–∏—è
SELECT subscription_id, user_id, charge_attempts, last_charge_attempt, status 
FROM subscriptions 
WHERE charge_attempts > 0;

-- –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–æ–∫ —Å –∏—Å—Ç–µ–∫—à–∏–º —Å—Ä–æ–∫–æ–º
SELECT subscription_id, user_id, charge_attempts, status 
FROM subscriptions 
WHERE status = 'expired' AND charge_attempts >= 3;

-- –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–≤–æ–≥–æ –ø–ª–∞—Ç–µ–∂–∞ –¥–ª—è –ø–æ–¥–ø–∏—Å–∫–∏
SELECT s.subscription_id, s.user_id, o.order_code as first_payment_inv_id
FROM subscriptions s
JOIN orders o ON s.order_id = o.order_id
WHERE s.subscription_id = 1;
```

## –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º

### –ü—Ä–∏ –Ω–µ—É–¥–∞—á–Ω–æ–º —Å–ø–∏—Å–∞–Ω–∏–∏ (–ø–æ–ø—ã—Ç–∫–∏ 1-2):
```
‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å —Å–ø–∏—Å–∞—Ç—å –æ–ø–ª–∞—Ç—É –∑–∞ –ø–æ–¥–ø–∏—Å–∫—É. –≠—Ç–æ –ø–æ—Å–ª–µ–¥–Ω—è—è –ø–æ–ø—ã—Ç–∫–∞. 
–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–∞–Ω–Ω—ã–µ –∫–∞—Ä—Ç—ã –∏–ª–∏ –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É.
```

### –ü—Ä–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏ –ø–æ–ø—ã—Ç–æ–∫ (–ø–æ–ø—ã—Ç–∫–∞ 3):
```
‚ùå –í–∞—à–∞ –ø–æ–¥–ø–∏—Å–∫–∞ –±—ã–ª–∞ –ø—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –∏–∑-–∑–∞ –Ω–µ—É–¥–∞—á–Ω—ã—Ö –ø–æ–ø—ã—Ç–æ–∫ —Å–ø–∏—Å–∞–Ω–∏—è. 
–î–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –¥–æ—Å—Ç—É–ø–∞ –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É.
```

### –ü—Ä–∏ —É—Å–ø–µ—à–Ω–æ–º —Å–ø–∏—Å–∞–Ω–∏–∏:
```
‚úÖ –í–∞—à–∞ –ø–æ–¥–ø–∏—Å–∫–∞ —É—Å–ø–µ—à–Ω–æ –ø—Ä–æ–¥–ª–µ–Ω–∞!
```

## –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–≤

–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –∏–Ω—Ç–µ—Ä–≤–∞–ª –º–µ–∂–¥—É –ø–æ–ø—ã—Ç–∫–∞–º–∏ —Å–æ—Å—Ç–∞–≤–ª—è–µ—Ç **1 –¥–µ–Ω—å**. 

–î–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏–Ω—Ç–µ—Ä–≤–∞–ª–∞ –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ –≤ `src/subscription_jobs.py`:

```python
# –°—Ç—Ä–æ–∫–∞ 95: –∏–∑–º–µ–Ω–∏—Ç—å timedelta(days=1) –Ω–∞ –Ω—É–∂–Ω—ã–π –∏–Ω—Ç–µ—Ä–≤–∞–ª
when=timedelta(days=1)  # –ù–∞–ø—Ä–∏–º–µ—Ä, timedelta(hours=12) –¥–ª—è 12 —á–∞—Å–æ–≤
```

## –û—Ç–∫–∞—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π

–ï—Å–ª–∏ –ø–æ—Ç—Ä–µ–±—É–µ—Ç—Å—è –æ—Ç–∫–∞—Ç–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è:

1. **–û—Ç–∫–∞—Ç –∫–æ–¥–∞**: –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –≤–µ—Ä—Å–∏–∏ —Ñ–∞–π–ª–æ–≤ –∏–∑ git
2. **–û—Ç–∫–∞—Ç –ë–î**: 
   ```sql
   ALTER TABLE subscriptions DROP COLUMN IF EXISTS charge_attempts;
   ALTER TABLE subscriptions DROP COLUMN IF EXISTS last_charge_attempt;
   ```

## –ü–æ–¥–¥–µ—Ä–∂–∫–∞

–ü—Ä–∏ –≤–æ–∑–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏–∏ –ø—Ä–æ–±–ª–µ–º:

1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –±–æ—Ç–∞ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –æ—à–∏–±–æ–∫
2. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ SQL-—Å–∫—Ä–∏–ø—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
4. –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Ç–µ—Å—Ç–æ–≤—ã–π —Å–∫—Ä–∏–ø—Ç –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
5. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –ø–µ—Ä–≤—ã–π –ø–ª–∞—Ç–µ–∂ –ø–æ–¥–ø–∏—Å–∫–∏ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö

## –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

### –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —á–µ—Ä–µ–∑ SQL

```sql
-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ–ø—ã—Ç–æ–∫ —Å–ø–∏—Å–∞–Ω–∏—è
SELECT 
    COUNT(*) as total_subscriptions,
    SUM(CASE WHEN charge_attempts = 0 THEN 1 ELSE 0 END) as successful,
    SUM(CASE WHEN charge_attempts > 0 AND charge_attempts < 3 THEN 1 ELSE 0 END) as retrying,
    SUM(CASE WHEN charge_attempts >= 3 THEN 1 ELSE 0 END) as failed
FROM subscriptions 
WHERE status = 'active';

-- –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–≤–æ–≥–æ –ø–ª–∞—Ç–µ–∂–∞ –¥–ª—è –≤—Å–µ—Ö –ø–æ–¥–ø–∏—Å–æ–∫
SELECT 
    s.subscription_id,
    s.user_id,
    o.order_code as first_payment_inv_id,
    s.charge_attempts
FROM subscriptions s
JOIN orders o ON s.order_id = o.order_id
WHERE s.status = 'active';
```

### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ

–î–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ–¥–ø–∏—Å–æ–∫ –ø–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–æ–±–ª–µ–º —Å –∫–∞—Ä—Ç–æ–π:

```sql
-- –°–±—Ä–æ—Å –ø–æ–ø—ã—Ç–æ–∫ –¥–ª—è –≤—Å–µ—Ö –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–¥–ø–∏—Å–æ–∫
UPDATE subscriptions 
SET charge_attempts = 0, last_charge_attempt = NULL 
WHERE status = 'active' AND charge_attempts > 0;
```

## –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

### –õ–æ–≥–∏–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è previous_inv_id

```python
# –ü–æ–ª—É—á–∞–µ–º –ø–µ—Ä–≤—ã–π –ø–ª–∞—Ç–µ–∂ –¥–ª—è —Ä–µ–∫—É—Ä—Ä–µ–Ω—Ç–Ω–æ–≥–æ —Å–ø–∏—Å–∞–Ω–∏—è
first_payment_inv_id = pdb.get_first_payment_for_subscription(subscription_id)
if not first_payment_inv_id:
    logger.error(f"‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –ø–µ—Ä–≤—ã–π –ø–ª–∞—Ç–µ–∂ –¥–ª—è –ø–æ–¥–ø–∏—Å–∫–∏ {subscription_id}")
    return

# –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–µ—Ä–≤—ã–π –ø–ª–∞—Ç–µ–∂ –¥–ª—è —Ä–µ–∫—É—Ä—Ä–µ–Ω—Ç–Ω–æ–≥–æ —Å–ø–∏—Å–∞–Ω–∏—è
await payment.create_recurring_payment_robokassa(
    # ... –¥—Ä—É–≥–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã ...
    previous_inv_id=first_payment_inv_id  # –ü–µ—Ä–≤—ã–π –ø–ª–∞—Ç–µ–∂ –ø–æ–¥–ø–∏—Å–∫–∏
)
```

–≠—Ç–æ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç, —á—Ç–æ –≤—Å–µ —Ä–µ–∫—É—Ä—Ä–µ–Ω—Ç–Ω—ã–µ –ø–ª–∞—Ç–µ–∂–∏ —Å—Å—ã–ª–∞—é—Ç—Å—è –Ω–∞ –æ–¥–∏–Ω –∏ —Ç–æ—Ç –∂–µ –ø–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω—ã–π –ø–ª–∞—Ç–µ–∂, —á—Ç–æ —è–≤–ª—è–µ—Ç—Å—è —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–µ–º Robokassa –¥–ª—è —Ä–µ–∫—É—Ä—Ä–µ–Ω—Ç–Ω—ã—Ö —Å–ø–∏—Å–∞–Ω–∏–π. 